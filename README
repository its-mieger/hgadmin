* Introduction

Hgadmin is a set of tools intended to simplify
    user and group management, 
    authentication, and
    access control
for shared mercurial repositories.


Hgadmin's intended scenario is:

 - a set of users (optionally organized in groups)
 - a set of repositories (all residing below one directory)
 - a user may be allowed to read or write to some repositories
 - a user may be allowed to create new repositories in some subdirectory
 - read/write access is possible via ssh and https
 - creation is possible only via ssh

* Hgadmin for users

** Overview

   Hgadmin as a tool is mainly intended to ease system administration.

   End users should not notice anything related to hgadmin, except
   hopefully that "everything just works"(tm)

** Requirements
   As end user, you only need a computer with mercurial.

   A repository server managed with hgadmin will typically export
   several repositories. These repositories can be accessed via ssh or
   http(s); hgadmin will manage access control and authentication for
   both access methods at the same time.

   For http(s) access, typically a password will be needed.
   Currently, hgadmin supports htpasswd - files as used by apache and
   several other web servers. An end user will therefore have to set a
   password. Setting this password is out of scope of hgadmin; contact
   your system administrators for related information.

   For ssh access, a ssh key is needed. An end user will have to
   create a ssh key and submit its public part to the administrators.

   Additionally, the administrators will have to configure which
   repositories the user has read- and commit-access.

** Usage

   After setting a password and submitting a ssh key, an end user can
   use the repositories managed by hgadmin exactly like any other
   remote mercurial repository.

   Creating new repositories on the server managed by hgadmin also
   works exactly as expected; even if this functionality is supported
   only via ssh.

* Hgadmin for administrators

** Overview

Hgadmin requires a "Configuration Directory" to keep a user/group
database, access configuration, password-hashfile (htpasswd-format) and ssh-keys.

It uses this information to do the following things:

  - replace the htpasswd file used by the webserver, if password
    information changes
  - generate access configuration for each managed repository by
    changing the settings in the "[web]" section of the repository
    configuration; namely, the values of the "deny_read",
    "allow_read", "deny_push" and "allow_push" options.
  - generate a authorized_keys file for ssh, that allowes the known
    keys to call a special wrapper script
  - said wrapper script uses the same contents of the "[web]" section
    of the repository configuration to determine whether a user can
    access the repository.

** Comparison with other tools

- mercurial-server
  hgadmin supports groups (which mercurial-server does not)
  hgadmin supports users, whereas mercurial-server just does access control for keys
  hgadmin supports access via https 
  hgadmin is about as complicated to set up as mercurial-server

- rhodecode
  hgadmin supports access via ssh (which rhodecode does not)
  hgadmin does not require a web server or some complicated setup



** Installation

After installation, the hgadmin scripts are installed on your
system, but not yet configured.

Basic installation consists of these steps:

  - Clone the hgadmin repository
	Example: hg clone https://www.hawo-net.de/~jakob/repos/hgadmin /opt/hgadmin

  - Put the hgadmin executables somewhere in the PATH
	Example: ln -s /opt/hgadmin/{hgadmin,mkconfrepo,hg-ssh} /usr/local/bin


** Configuration

All the configuration of hgadmin resides in one directory.

*** Example

For this example, the managed repositories reside under "/var/repos".

The hgadmin configuration directory is at "/home/hg/hgadmin-config";
the hgadmin scripts are at "/opt/hgadmin"

The ssh authorized_keys file is at "/home/hg/.ssh/authorized_keys";
the htpasswd file is at "/var/www/repos/htpasswd".

**** 'config' file
The main configuration file is "/home/hg/hgadmin-config/config":
>   [paths]
>   repopath = /var/repos
>   htpasswdpath = /var/www/repos/htpasswd
>   hg-ssh = /opt/hgadmin/hg-ssh
>   sshauthkeyspath = /home/hg/.ssh/authorized_keys
>   
>   [groups]
>   group1 = user1, user2
>   group2 = user2, user3, user4
>   
>   [users]
>   users = user1, user2,
>    # strange user with own description:
>      user3,
>    # another user description
>      user4
>    # and another user description
>      user5

It contains the relevant paths, a list of users and a list of groups,
together with the users they contain.

If the "htpasswdpath" option is not specified, hgadmin will not update
it. Likewise, if either the "hg-ssh" option or the "sshauthkeyspath"
option are not specified, hgadmin will not update the authorized_keys
file.  If the "repopath" option is missing, hgadmin will simply
complain and do nothing.

If user or group names contain invalid characters, or if groups
reference unknown users, hgadmin will display a warning and ignore
these users and/or groups.

**** 'access' file
The access configuration is at "/home/hg/hgadmin-config/access":
>   [/**]
>   user1 = rw
>   user2 = r
>   [/sandbox/*]
>   user2 = rw
>   user3 = rw
>   user4 = r
>   [/sandbox/foo]
>   user1 = r
>   user4 = rw 

In this configuration, presume there are three repositories:
  (a) "/var/repos/test"
  (b) "/var/repos/sandbox/bar"
  (c) "/var/repos/sandbox/foo" 

(a) can be read by user1 and user2, and written by user1.  

(b) can be read by user1, user2, user3 and user4. it can be written by
user1, user2 and user3.

(c) can be read by user1, user2 and user4. It can be written by user4,
user3 and user2, but not by user1.

**** 'hgrc' file:
The 'hgrc' file is at "/home/hg/hgadmin-config/hgrc":
>   [hooks]
>   incoming.email = /my/email/hook
>   [web]
>   allow_archive = gz, zip
>   contact = "admin" <admin@somedomain>

Its contents get inserted into the repository local mercurial
configuration for every managed repository.

In this case, it means that the (email sending) hook is executed every
time someone pushes changes to a repository, and that the hgweb cgi
will allow downloading of the specified archives and will show the
configured contact.

**** 'hgrc_web' file:
The 'hgrc_web' file is at "/home/hg/hgadmin-config/hgrc_web":

Its contents get inserted into the [web] section of the repository
local mercurial configuration for every managed repository.

Note that the 'hgrc_web' file MUST NOT contain ANY section - all of
its settings end up in the [web] section; if you need a setting placed
in another section put it in the 'hgrc' file!



**** 'htpasswd' file:
TODO

**** old stuff...
------------------------------------------------

General configuration variables:

     USER=hg
	 REPODIR=/var/repos
	 CONFDIR=/home/hg/hgadmin-config

Creation of the repository directory and configuration directory:

     mkdir $REPODIR
	 chown $USER $REPODIR
	 su $USER mkconfrepo $CONFDIR
TODO: hooks!	 

Assuming that you have a ssh key to administrate hgadmin, which
resides in "/tmp/admin_ssh_key":

     su - $USER mkdir -p .ssh
	 su - $USER chmod go-rwx .ssh
	 cp /tmp/admin_ssh_key /home/$USER/.ssh/authorized_keys_const
	 chown $USER /home/$USER/.ssh/authorized_keys_const
	 chmod go-rwx /home/$USER/.ssh/authorized_keys_const



echo -e "[paths]\n/ = $REPODIR/**\n" >> $REPODIR/repos.cfg


*** Description of the Configuration Directory

There are four configuration files and one directory for the users'
ssh keys.

**** 'config' file

The first configuration file is named 'config'. Its format is standard
ini-format (as understood by python's ConfigParser).

There are three sections in the 'config'-file, named 'paths', 'groups' and 'users'.

The section 'paths' has six possible settings:

  - 'repopath' -- directory path that contains the managed repositories
  - 'htpasswdpath' -- path to the htpasswdfile, if present
  - 'sshauthkeyspath' -- path to the authorized_keys file
  - 'hg-ssh' -- path to the hg-ssh script

The section 'users' has exactly one setting, named 'users'.
Its value is a comma separated list of the users.

The section 'groups' contains the groups. A groupname is encoded in
the name of a setting; the users belonging to the group end up in the
value of the setting.

**** 'access' file:

The names of the configuration sections refer to repositories.

If a name ends with two '*' characters, it is a wildcard referring to
everything below this directory down to arbitrary depth.

If a name ends with a single '*' character, it is a wildcard referring to
everything immediately inside this directory.

If a name does not end with a '*' character, it directly and
immediately refers to a repository.

**** 'hgrc' file:
TODO
**** 'htpasswd' file:
TODO

** The scripts

This package consists of three scripts, hg-ssh, hgadmin and mkconfrepo.

*** hg-ssh

hg-ssh is supposed to be invoked by the ssh-server as a wrapper around
the "ordinary" hg, via the "command=..." option in the authorized_keys
file.

Note that hg-ssh is only used internally by hgadmin. Ordinarily, a
system administrator need not care about it.

Given that hg-ssh is the only part that faces direct communication
with external users, here a description of its actions:

hg-ssh requires three arguments on execution. Its first argument is
the directory where the repositories are located. Its second argument
ist the user associated with the ssh-key. Its third argument is the
directory where the configuration data for hgadmin resides.

hg-ssh will parse the environment variable SSH_ORIGINAL_COMMAND (as
set by ssh) for an attempt at repository creation or access. If
neither matches, hg-ssh will exit. 

If the value of SSH_ORIGINAL_COMMAND looks like an attempt at
repository creation (i.e. it matches the regex '^hg init .*$'), hg-ssh
will check whether repository creation is enabled. If so, it will pass
the name of the repository to be created, the creating user and the
configuration directory to the hgadmin script.

If the value of SSH_ORIGINAL_COMMAND looks like an attempt at
repository access (i.e. it matches the regex '^hg -R .* serve --stdio$'), 
hg-ssh will check whether a directory with this name exists and looks
like it is managed by hgadmin (by checking the presence of the file
'.hg/ADMINISTRATED_BY_HGADMIN'). If said file is not present, hg-ssh
will abort.  Next, hg-ssh will attempt to parse the repository-local
configuration and check whether its username is present in the list of
users allowed to read from or write to the repository. If the user is
not allowed to read, hg-ssh will abort.  If the user is not allowed to
write to the repository, hg-ssh will execute:

'hg serve --stdio -R REPO --config hooks.prechangegroup=false --config hooks.pretxnchangegroup=false'

Otherwise (i.e. if the user is allowed to read and write) hg-ssh will
execute:

'hg serve --stdio -R REPO'.

This hg-ssh script differs from the hg-ssh script found in the
mercurial distribution, in that it:
  - does not require all allowed repositories to be mentioned on the
    commandline instead, the (known) username is checked against the
    web configuration in the repository
  – allowes repository creation (by invoking hgadmin)

*** hgadmin

The hgadmin script serves several purposes, depending on the way it is
called. 

If called like 'hgadmin create_repo PATH' it will read the
configuration and create a repository.

If called like 'hgadmin updateauth' it will read its configuration,
and refresh access configuration; i.e. it will regenerate and update
the htpasswd-file, the authorized_keys file and every repository
configuration file.

If called like 'hgadmin verify', it will read the configuration, and
exit successfully if the configuration is valid. If the configuration
is inconsistent, it will exit unsuccessfully.

If called like 'hgadmin accesscheck ACCESSTYPE USER PATH', the script
will read the configuration and check (and report) whether the user
USER is allowed access ACCESSTYPE to a (potentially not yet existing)
repository located at PATH.

All these invocations share these options:
  - "-D"            - enables debugging output
  - "--confdir DIR" - sets configuration directory to DIR
	
*** mkconfrepo
